<link rel="apple-touch-icon" sizes="180x180" href="{{ "/images/apple-touch-icon.png" | relative_url }}">
<link rel="icon" type="image/png" sizes="32x32" href="{{ "/images/favicon-32x32.png" | relative_url }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ "/images/favicon-16x16.png" | relative_url }}">
<link rel="manifest" href="{{ "/images/site.webmanifest" | relative_url }}">

<meta name="msapplication-TileColor" content="#000000">
<meta name="msapplication-TileImage" content="{{ "/images/mstile-144x144.png?v=M44lzPylqQ" | relative_url }}">
<meta name="msapplication-config" content="{{ "/images/browserconfig.xml?v=M44lzPylqQ" | relative_url }}">
<meta name="theme-color" content="#ffffff">
<link rel="stylesheet" href="{{ "/assets/css/academicons.css" | relative_url }}"/>

<style>
  .proof-environment {
    margin: 1em 0;
    text-align: left;
  }
  .proof-environment .proof-title {
    font-weight: bold;
    margin-bottom: 0.5em;
  }
  .proof-environment .proof-content {
    line-height: 1.8;
  }
  .proof-environment .proof-qed {
    text-align: right;
    margin-top: 0.5em;
    font-size: 1.5em;
  }
  
  .itemize-environment {
    margin: 1em 0;
    text-align: left;
  }
  .itemize-environment ul {
    list-style-type: disc;
    padding-left: 2em;
    margin: 0.5em 0;
  }
  .itemize-environment li {
    margin: 0.3em 0;
    text-align: left;
  }
</style>

<script>
  function processItemizeInContent(content) {
    // 处理内容中的 itemize 环境，将其转换为 HTML
    var itemizePattern = /\\begin\{itemize\}([\s\S]*?)\\end\{itemize\}/g;
    
    content = content.replace(itemizePattern, function(match, itemContent) {
      // 分割 \item
      var items = itemContent.split(/\\item\s*/);
      var listItems = '';
      
      items.forEach(function(item) {
        item = item.trim();
        if (item) {
          // 每个 item 内容可能包含数学公式，保留它们
          listItems += '<li>' + item + '</li>';
        }
      });
      
      // 返回一个特殊标记，稍后会被替换为实际的 HTML
      var id = 'itemize-placeholder-' + Math.random().toString(36).substr(2, 9);
      var itemizeHtml = '<div class="itemize-environment" data-id="' + id + '">' +
        '<ul>' + listItems + '</ul>' +
        '</div>';
      
      // 将 HTML 存储起来
      if (!window.itemizePlaceholders) {
        window.itemizePlaceholders = {};
      }
      window.itemizePlaceholders[id] = itemizeHtml;
      
      return '{{ITEMIZE_' + id + '}}';
    });
    
    return content;
  }

  function preprocessProofEnvironments() {
    var contentNode = document.querySelector('.page__content, .apple-article-body');
    if (!contentNode) return;
    
    var html = contentNode.innerHTML;
    
    // 匹配 $$\begin{proof}...\end{proof}$$ 或 \[\begin{proof}...\end{proof}\]
    var proofPattern = /(\$\$|\\\[)\s*\\begin\{proof\}([\s\S]*?)\\end\{proof\}\s*(\$\$|\\\])/g;
    
    html = html.replace(proofPattern, function(match, openDelim, content, closeDelim) {
      var id = 'proof-' + Math.random().toString(36).substr(2, 9);
      
      // 先处理内容中的 itemize 环境
      content = processItemizeInContent(content);
      
      var proofHtml = '<div class="proof-environment" id="' + id + '">' +
        '<div class="proof-title">Proof.</div>' +
        '<div class="proof-content">' + content.trim() + '</div>' +
        '<div class="proof-qed">□</div>' +
        '</div>';
      
      return proofHtml;
    });
    
    contentNode.innerHTML = html;
  }

  function restoreItemizePlaceholders() {
    // 在 MathJax 渲染后，替换 itemize 占位符
    if (!window.itemizePlaceholders) return;
    
    var contentNode = document.querySelector('.page__content, .apple-article-body');
    if (!contentNode) return;
    
    Object.keys(window.itemizePlaceholders).forEach(function(id) {
      var placeholder = '{{ITEMIZE_' + id + '}}';
      var itemizeHtml = window.itemizePlaceholders[id];
      
      // 查找包含占位符的元素
      var walker = document.createTreeWalker(
        contentNode,
        NodeFilter.SHOW_TEXT,
        null,
        false
      );
      
      var nodesToReplace = [];
      var node;
      
      while (node = walker.nextNode()) {
        if (node.textContent.includes(placeholder)) {
          nodesToReplace.push(node);
        }
      }
      
      nodesToReplace.forEach(function(textNode) {
        var parent = textNode.parentNode;
        var parts = textNode.textContent.split(placeholder);
        
        var fragment = document.createDocumentFragment();
        
        if (parts[0]) {
          fragment.appendChild(document.createTextNode(parts[0]));
        }
        
        var tempDiv = document.createElement('div');
        tempDiv.innerHTML = itemizeHtml;
        var itemizeElement = tempDiv.firstChild;
        fragment.appendChild(itemizeElement);
        
        if (parts[1]) {
          fragment.appendChild(document.createTextNode(parts[1]));
        }
        
        parent.replaceChild(fragment, textNode);
      });
    });
  }

  function preprocessItemizeEnvironments() {
    var contentNode = document.querySelector('.page__content, .apple-article-body');
    if (!contentNode) return;
    
    var html = contentNode.innerHTML;
    
    // 处理独立的 itemize 环境（不在 proof 中的）
    var itemizePattern = /(\$\$|\\\[)\s*\\begin\{itemize\}([\s\S]*?)\\end\{itemize\}\s*(\$\$|\\\])/g;
    
    html = html.replace(itemizePattern, function(match, openDelim, content, closeDelim) {
      var id = 'itemize-' + Math.random().toString(36).substr(2, 9);
      
      var items = content.split(/\\item\s*/);
      var listItems = '';
      
      items.forEach(function(item) {
        item = item.trim();
        if (item) {
          listItems += '<li>' + item + '</li>';
        }
      });
      
      var itemizeHtml = '<div class="itemize-environment" id="' + id + '">' +
        '<ul>' + listItems + '</ul>' +
        '</div>';
      
      return itemizeHtml;
    });
    
    contentNode.innerHTML = html;
  }

  function fixInternalLinks() {
    document.addEventListener('click', function(e) {
      var target = e.target;
      
      while (target && target.tagName !== 'A') {
        target = target.parentElement;
      }
      
      if (!target || target.tagName !== 'A') return;
      
      var href = target.getAttribute('href');
      
      if (href && href.startsWith('#')) {
        e.preventDefault();
        
        var targetId = href.substring(1);
        var targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          if (window.history && window.history.pushState) {
            window.history.pushState(null, '', href);
          }
        }
      }
    });
  }

  function applyAppleEquationNumbers() {
    var blocks = document.querySelectorAll('.apple-article-body mjx-container[display="true"]');
    var counter = 0;

    blocks.forEach(function (block) {
      var hasMathJaxTag = block.querySelector('mjx-tag') || block.querySelector('.mjx-tag');
      block.classList.add('apple-equation-block');

      if (hasMathJaxTag) {
        return;
      }

      counter += 1;
      var numberEl = block.querySelector('.apple-equation-number');
      if (!numberEl) {
        numberEl = document.createElement('span');
        numberEl.className = 'apple-equation-number';
        block.appendChild(numberEl);
      }
      numberEl.textContent = '(' + counter + ')';
    });
  }

  function normalizeCodeLanguageClasses() {
    var nodes = document.querySelectorAll('pre[class], code[class], div[class], figure[class]');
    var knownLanguages = ['latex', 'python'];

    nodes.forEach(function (node) {
      var classNames = Array.from(node.classList);
      classNames.forEach(function (className) {
        var lowerClass = className.toLowerCase();
        var languageMatch = className.match(/^language-(.+)$/i);

        if (languageMatch) {
          var normalizedLanguageClass = 'language-' + languageMatch[1].toLowerCase();
          if (normalizedLanguageClass !== className) {
            node.classList.remove(className);
          }
          if (!node.classList.contains(normalizedLanguageClass)) {
            node.classList.add(normalizedLanguageClass);
          }
          return;
        }
        if (knownLanguages.indexOf(lowerClass) !== -1) {
          if (lowerClass !== className) {
            node.classList.remove(className);
          }
          if (!node.classList.contains(lowerClass)) {
            node.classList.add(lowerClass);
          }
          if (!node.classList.contains('language-' + lowerClass)) {
            node.classList.add('language-' + lowerClass);
          }
        }
      });
    });
  }

  function pageHasMathContent() {
    var contentNode = document.querySelector('.page__content, .apple-article-body');
    if (!contentNode) {
      return false;
    }

    var rawText = contentNode.textContent || '';
    var hasDisplayOrLatexMarkers = /\$\$|\\\(|\\\)|\\\[|\\\]|\\begin\{|\\operatorname\{|\\boldsymbol\{|\\mathbb\{/.test(rawText);
    var hasInlineDollarMath = /(^|[^\\])\$[^$\n]+\$(?!\$)/.test(rawText);
    return hasDisplayOrLatexMarkers || hasInlineDollarMath;
  }

  function configureMathJax() {
    var commonTexPackages = [
      'ams',
      'newcommand',
      'configmacros',
      'textmacros',
      'mathtools',
      'physics',
      'cancel',
      'color',
      'braket',
      'html'
    ];

    var defaultMacros = {
      determinant: ['\\lvert #1 \\rvert', 1],
      item: '\\\\ \\text{• }'
    };
    var pageMacros = {{ page.mathjax_macros | jsonify }} || {};

    window.MathJax = {
      loader: {
        load: commonTexPackages.map(function (pkg) {
          return '[tex]/' + pkg;
        })
      },
      tex: {
        packages: {
          '[+]': commonTexPackages
        },
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        macros: Object.assign({}, defaultMacros, pageMacros),
        environments: {
          // proof 和 itemize 已通过 JavaScript 预处理
        },
        processEscapes: true,
        processEnvironments: true,
        tags: 'all'
      },
      chtml: {
        linebreaks: {
          automatic: true,
          width: 'container'
        }
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      startup: {
        pageReady: function () {
          return MathJax.startup.defaultPageReady().then(function () {
            applyAppleEquationNumbers();
            restoreItemizePlaceholders();  // 在 MathJax 渲染后恢复 itemize
          });
        }
      }
    };
  }

  function loadMathJaxIfNeeded() {
    var frontMatterEnabled = {{ page.mathjax | default: false | jsonify }};
    if (!frontMatterEnabled && !pageHasMathContent()) {
      return;
    }
    if (!window.MathJax) {
      configureMathJax();
    }

    if (!document.querySelector('link[data-mathjax-preconnect]')) {
      var preconnect = document.createElement('link');
      preconnect.rel = 'preconnect';
      preconnect.href = 'https://cdn.jsdelivr.net';
      preconnect.crossOrigin = 'anonymous';
      preconnect.setAttribute('data-mathjax-preconnect', 'true');
      document.head.appendChild(preconnect);
    }

    if (!document.querySelector('script[data-mathjax-script]')) {
      var script = document.createElement('script');
      script.defer = true;
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js';
      script.setAttribute('data-mathjax-script', 'true');
      document.head.appendChild(script);
      return;
    }

    if (window.MathJax && MathJax.typesetPromise) {
      MathJax.typesetPromise().then(function () {
        applyAppleEquationNumbers();
        restoreItemizePlaceholders();  // 在重新渲染后恢复 itemize
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    preprocessProofEnvironments();      // 先处理 proof（包含内部的 itemize）
    preprocessItemizeEnvironments();    // 再处理独立的 itemize
    normalizeCodeLanguageClasses();
    loadMathJaxIfNeeded();
    fixInternalLinks();
  });
</script>

<!-- end custom head snippets -->