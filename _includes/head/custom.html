<link rel="apple-touch-icon" sizes="180x180" href="{{ "/images/apple-touch-icon.png" | relative_url }}">
<link rel="icon" type="image/png" sizes="32x32" href="{{ "/images/favicon-32x32.png" | relative_url }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ "/images/favicon-16x16.png" | relative_url }}">
<link rel="manifest" href="{{ "/images/site.webmanifest" | relative_url }}">

<meta name="msapplication-TileColor" content="#000000">
<meta name="msapplication-TileImage" content="{{ "/images/mstile-144x144.png?v=M44lzPylqQ" | relative_url }}">
<meta name="msapplication-config" content="{{ "/images/browserconfig.xml?v=M44lzPylqQ" | relative_url }}">
<meta name="theme-color" content="#ffffff">
<link rel="stylesheet" href="{{ "/assets/css/academicons.css" | relative_url }}"/>

<style>
  .proof-environment {
    margin: 1em 0;
    text-align: left;
  }
  .proof-environment .proof-title {
    font-weight: bold;
    margin-bottom: 0.5em;
  }
  .proof-environment .proof-content {
    line-height: 1.8;
  }
  .proof-environment .proof-qed {
    text-align: right;
    margin-top: 0.5em;
    font-size: 2em;
  }
  
  .itemize-environment {
    margin: 1em 0;
    text-align: left;
  }
  .itemize-environment ul {
    list-style-type: disc;
    padding-left: 2em;
    margin: 0;
  }
  .itemize-environment li {
    margin: 0.3em 0;
    text-align: left;
  }

  .apple-floating-share-button {
    position: fixed;
    right: 24px;
    bottom: 24px;
    z-index: 1200;
    border: 0;
    border-radius: 999px;
    background: #007aff;
    color: #fff;
    padding: 10px 16px;
    font-size: 14px;
    cursor: pointer;
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.2);
  }

  .apple-floating-share-button:hover {
    background: #0062cc;
  }
</style>

<script>
  // 在内容中处理 itemize 环境的辅助函数
  function preprocessItemizeInContent(content) {
    var itemizePattern = /\\begin\{itemize\}([\s\S]*?)\\end\{itemize\}/g;
    
    return content.replace(itemizePattern, function(match, items) {
      var id = 'itemize-' + Math.random().toString(36).substr(2, 9);
      
      // 分割 \item
      var itemList = items.split(/\\item/);
      var listItems = '';
      
      itemList.forEach(function(item) {
        item = item.trim();
        if (item) {
          listItems += '<li>' + item + '</li>';
        }
      });
      
      return '<div class="itemize-environment" id="' + id + '">' +
        '<ul>' + listItems + '</ul>' +
        '</div>';
    });
  }

  function preprocessProofEnvironments() {
    var contentNode = document.querySelector('.page__content, .apple-article-body');
    if (!contentNode) return;
    
    var html = contentNode.innerHTML;
    
    // 匹配 \begin{proof}...\end{proof}（可选 $$ 或 \[ \] 包裹）
    var proofPattern = /((\$\$|\\\[)\s*)?\\begin\{proof\}([\s\S]*?)\\end\{proof\}(\s*(\$\$|\\\]))?/g;
    
    html = html.replace(proofPattern, function(match, wrappedOpen, openDelim, content, wrappedClose, closeDelim) {
      var id = 'proof-' + Math.random().toString(36).substr(2, 9);
      
      // 先在 proof 内容中处理 itemize 环境
      var processedContent = preprocessItemizeInContent(content.trim());
      
      var proofHtml = '<div class="proof-environment" id="' + id + '">' +
        '<div class="proof-title">Proof.</div>' +
        '<div class="proof-content">' + processedContent + '</div>' +
        '<div class="proof-qed">□</div>' +
        '</div>';
      
      return proofHtml;
    });
    
    contentNode.innerHTML = html;
  }

  function preprocessItemizeEnvironments() {
    var contentNode = document.querySelector('.page__content, .apple-article-body');
    if (!contentNode) return;
    
    var html = contentNode.innerHTML;
    
    // 处理独立的 itemize 环境（不在 proof 中的），支持是否使用 $$ 包裹
    var itemizePattern = /((\$\$|\\\[)\s*)?\\begin\{itemize\}([\s\S]*?)\\end\{itemize\}(\s*(\$\$|\\\]))?/g;
    
    html = html.replace(itemizePattern, function(match, wrappedOpen, openDelim, content, wrappedClose, closeDelim) {
      var id = 'itemize-' + Math.random().toString(36).substr(2, 9);
      
      // 分割 \item
      var items = content.split(/\\item/);
      var listItems = '';
      
      items.forEach(function(item) {
        item = item.trim();
        if (item) {
          listItems += '<li>' + item + '</li>';
        }
      });
      
      var itemizeHtml = '<div class="itemize-environment" id="' + id + '">' +
        '<ul>' + listItems + '</ul>' +
        '</div>';
      
      return itemizeHtml;
    });
    
    contentNode.innerHTML = html;
  }

  function slugifyHeadingText(text) {
    return text
      .toLowerCase()
      .trim()
      .replace(/<[^>]*>/g, '')
      .replace(/[\s]+/g, '-')
      .replace(/[^\w\-\u4e00-\u9fa5]/g, '')
      .replace(/-+/g, '-');
  }

  function preprocessLatexSections() {
    var contentNode = document.querySelector('.page__content, .apple-article-body');
    if (!contentNode) return;

    var html = contentNode.innerHTML;
    var headingCounters = {};
    var headingMapping = {
      section: 'h1',
      subsection: 'h2',
      subsubsection: 'h3'
    };

    html = html.replace(/\\(section|subsection|subsubsection)\{([^}]+)\}/g, function(match, level, title) {
      var tagName = headingMapping[level];
      var baseId = slugifyHeadingText(title) || level;
      headingCounters[baseId] = (headingCounters[baseId] || 0) + 1;
      var headingId = headingCounters[baseId] > 1 ? baseId + '-' + headingCounters[baseId] : baseId;
      return '<' + tagName + ' id="' + headingId + '">' + title.trim() + '</' + tagName + '>';
    });

    contentNode.innerHTML = html;
  }

  function escapeCssSelector(value) {
    if (window.CSS && typeof window.CSS.escape === 'function') {
      return window.CSS.escape(value);
    }
    return value.replace(/([#.;?+*~':"!^$\[\]()=>|\/@])/g, '\\$1');
  }

  function findAnchorTargetElement(rawHash) {
    if (!rawHash) return null;

    var decodedHash = decodeURIComponent(rawHash);
    var targetId = decodedHash.replace(/^#/, '');
    if (!targetId) return null;

    return document.getElementById(targetId) ||
      document.querySelector('[name="' + escapeCssSelector(targetId) + '"]') ||
      document.querySelector('a[href="#' + escapeCssSelector(targetId) + '"]');
  }

  function scrollToHashTarget(rawHash) {
    var targetElement = findAnchorTargetElement(rawHash);
    if (!targetElement) return false;

    targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
    if (window.history && window.history.pushState) {
      window.history.pushState(null, '', '#' + decodeURIComponent(rawHash).replace(/^#/, ''));
    }
    return true;
  }

  function fixInternalLinks() {
    // 处理 MathJax 生成的内部引用链接
    document.addEventListener('click', function(e) {
      var target = e.target;
      
      // 查找是否是链接或链接内的元素
      while (target && target.tagName !== 'A') {
        target = target.parentElement;
      }
      
      if (!target || target.tagName !== 'A') return;
      
      var href = target.getAttribute('href');
      
      if (!href) return;

      // 检查是否是页面内锚点链接（#hash 或当前页面 URL + #hash）
      var isPureHash = href.startsWith('#');
      var isSamePageLink = false;

      if (!isPureHash) {
        var absoluteUrl = new URL(href, window.location.href);
        isSamePageLink = absoluteUrl.origin === window.location.origin &&
          absoluteUrl.pathname === window.location.pathname &&
          absoluteUrl.hash;
      }

      if (isPureHash || isSamePageLink) {
        e.preventDefault();
        
        var targetHash = isPureHash ? href : new URL(href, window.location.href).hash;
        scrollToHashTarget(targetHash);
      }
    });
  }

  function initPostShareButton() {
    var isPostPage = {{ page.collection | default: '' | jsonify }} === 'posts';
    if (!isPostPage) return;

    if (document.getElementById('apple-floating-share-button')) return;

    var shareButton = document.createElement('button');
    shareButton.id = 'apple-floating-share-button';
    shareButton.className = 'apple-floating-share-button';
    shareButton.type = 'button';
    shareButton.setAttribute('aria-label', 'Share current article');
    shareButton.textContent = '分享';
    document.body.appendChild(shareButton);

    function copyText(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        return navigator.clipboard.writeText(text);
      }

      return new Promise(function(resolve, reject) {
        var textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.setAttribute('readonly', '');
        textArea.style.position = 'absolute';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();

        var succeeded = document.execCommand('copy');
        document.body.removeChild(textArea);
        if (succeeded) {
          resolve();
        } else {
          reject(new Error('copy failed'));
        }
      });
    }

    shareButton.addEventListener('click', function () {
      var originalText = shareButton.textContent;
      copyText(window.location.href).then(function () {
        shareButton.textContent = '已复制链接';
      }).catch(function () {
        shareButton.textContent = '复制失败';
      }).finally(function () {
        setTimeout(function () {
          shareButton.textContent = originalText;
        }, 1600);
      });
    });
  }

  function applyAppleEquationNumbers() {
    var blocks = document.querySelectorAll('.apple-article-body mjx-container[display="true"]');
    var counter = 0;

    blocks.forEach(function (block) {
      var hasMathJaxTag = block.querySelector('mjx-tag') || block.querySelector('.mjx-tag');
      block.classList.add('apple-equation-block');

      if (hasMathJaxTag) {
        return;
      }

      counter += 1;
      var numberEl = block.querySelector('.apple-equation-number');
      if (!numberEl) {
        numberEl = document.createElement('span');
        numberEl.className = 'apple-equation-number';
        block.appendChild(numberEl);
      }
      numberEl.textContent = '(' + counter + ')';
    });
  }

  function normalizeCodeLanguageClasses() {
    var nodes = document.querySelectorAll('pre[class], code[class], div[class], figure[class]');
    var knownLanguages = ['latex', 'python'];

    nodes.forEach(function (node) {
      var classNames = Array.from(node.classList);
      classNames.forEach(function (className) {
        var lowerClass = className.toLowerCase();
        var languageMatch = className.match(/^language-(.+)$/i);

        if (languageMatch) {
          var normalizedLanguageClass = 'language-' + languageMatch[1].toLowerCase();
          if (normalizedLanguageClass !== className) {
            node.classList.remove(className);
          }
          if (!node.classList.contains(normalizedLanguageClass)) {
            node.classList.add(normalizedLanguageClass);
          }
          return;
        }
        if (knownLanguages.indexOf(lowerClass) !== -1) {
          if (lowerClass !== className) {
            node.classList.remove(className);
          }
          if (!node.classList.contains(lowerClass)) {
            node.classList.add(lowerClass);
          }
          if (!node.classList.contains('language-' + lowerClass)) {
            node.classList.add('language-' + lowerClass);
          }
        }
      });
    });
  }

  function pageHasMathContent() {
    var contentNode = document.querySelector('.page__content, .apple-article-body');
    if (!contentNode) {
      return false;
    }

    var rawText = contentNode.textContent || '';
    var hasDisplayOrLatexMarkers = /\$\$|\\\(|\\\)|\\\[|\\\]|\\begin\{|\\operatorname\{|\\boldsymbol\{|\\mathbb\{/.test(rawText);
    var hasInlineDollarMath = /(^|[^\\])\$[^$\n]+\$(?!\$)/.test(rawText);
    return hasDisplayOrLatexMarkers || hasInlineDollarMath;
  }

  function configureMathJax() {
    var commonTexPackages = [
      'ams',
      'newcommand',
      'configmacros',
      'textmacros',
      'mathtools',
      'physics',
      'cancel',
      'color',
      'braket',
      'html'
    ];

    var defaultMacros = {
      determinant: ['\\lvert #1 \\rvert', 1],
      item: '\\\\ \\text{• }'
    };
    var pageMacros = {{ page.mathjax_macros | jsonify }} || {};

    window.MathJax = {
      loader: {
        load: commonTexPackages.map(function (pkg) {
          return '[tex]/' + pkg;
        })
      },
      tex: {
        packages: {
          '[+]': commonTexPackages
        },
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        macros: Object.assign({}, defaultMacros, pageMacros),
        environments: {
          // proof 和 itemize 已通过 JavaScript 预处理，这里不再定义
        },
        processEscapes: true,
        processEnvironments: true,
        tags: 'all'
      },
      chtml: {
        linebreaks: {
          automatic: true,
          width: 'container'
        }
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      startup: {
        pageReady: function () {
          return MathJax.startup.defaultPageReady().then(function () {
            applyAppleEquationNumbers();
          });
        }
      }
    };
  }

  function loadMathJaxIfNeeded() {
    var frontMatterEnabled = {{ page.mathjax | default: false | jsonify }};
    if (!frontMatterEnabled && !pageHasMathContent()) {
      return;
    }
    if (!window.MathJax) {
      configureMathJax();
    }

    if (!document.querySelector('link[data-mathjax-preconnect]')) {
      var preconnect = document.createElement('link');
      preconnect.rel = 'preconnect';
      preconnect.href = 'https://cdn.jsdelivr.net';
      preconnect.crossOrigin = 'anonymous';
      preconnect.setAttribute('data-mathjax-preconnect', 'true');
      document.head.appendChild(preconnect);
    }

    if (!document.querySelector('script[data-mathjax-script]')) {
      var script = document.createElement('script');
      script.defer = true;
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js';
      script.setAttribute('data-mathjax-script', 'true');
      document.head.appendChild(script);
      return;
    }

    if (window.MathJax && MathJax.typesetPromise) {
      MathJax.typesetPromise().then(function () {
        applyAppleEquationNumbers();
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    preprocessLatexSections();          // 预处理 LaTeX 标题命令（section/subsection/subsubsection）
    preprocessProofEnvironments();      // 预处理 proof 环境（会同时处理内部的 itemize）
    preprocessItemizeEnvironments();    // 预处理独立的 itemize 环境
    normalizeCodeLanguageClasses();
    loadMathJaxIfNeeded();
    fixInternalLinks();                 // 修复内部链接跳转
    initPostShareButton();              // 仅文章页显示分享按钮

    // 页面首次加载时若自带 hash（例如从 \ref 跳转而来），自动定位到对应锚点
    if (window.location.hash) {
      setTimeout(function () {
        scrollToHashTarget(window.location.hash);
      }, 0);
    }
  });
</script>

<!-- end custom head snippets -->