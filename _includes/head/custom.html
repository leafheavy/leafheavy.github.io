<link rel="apple-touch-icon" sizes="180x180" href="{{ "/images/apple-touch-icon.png" | relative_url }}">
<link rel="icon" type="image/png" sizes="32x32" href="{{ "/images/favicon-32x32.png" | relative_url }}">
<link rel="icon" type="image/png" sizes="16x16" href="{{ "/images/favicon-16x16.png" | relative_url }}">
<link rel="manifest" href="{{ "/images/site.webmanifest" | relative_url }}">

<meta name="msapplication-TileColor" content="#000000">
<meta name="msapplication-TileImage" content="{{ "/images/mstile-144x144.png?v=M44lzPylqQ" | relative_url }}">
<meta name="msapplication-config" content="{{ "/images/browserconfig.xml?v=M44lzPylqQ" | relative_url }}">
<meta name="theme-color" content="#ffffff">
<link rel="stylesheet" href="{{ "/assets/css/academicons.css" | relative_url }}"/>

<style>
  .proof-environment {
    margin: 1em 0;
    text-align: left;
  }
  .proof-environment .proof-title {
    font-weight: bold;
    margin-bottom: 0.5em;
  }
  .proof-environment .proof-content {
    line-height: 1.8;
  }
  .proof-environment .proof-qed {
    text-align: right;
    margin-top: 0.5em;
    font-size: 1.5em;  /* 增大 □ 符号 */
  }
  
  .itemize-environment {
    margin: 1em 0;
    text-align: left;
  }
  .itemize-environment ul {
    list-style-type: disc;
    padding-left: 2em;
    margin: 0;
  }
  .itemize-environment li {
    margin: 0.3em 0;
    text-align: left;
  }
</style>

<script>
  // 在内容中处理 itemize 环境的辅助函数
  function preprocessItemizeInContent(content) {
    var itemizePattern = /\\begin\{itemize\}([\s\S]*?)\\end\{itemize\}/g;
    
    return content.replace(itemizePattern, function(match, items) {
      var id = 'itemize-' + Math.random().toString(36).substr(2, 9);
      
      // 分割 \item
      var itemList = items.split(/\\item/);
      var listItems = '';
      
      itemList.forEach(function(item) {
        item = item.trim();
        if (item) {
          listItems += '<li>' + item + '</li>';
        }
      });
      
      return '<div class="itemize-environment" id="' + id + '">' +
        '<ul>' + listItems + '</ul>' +
        '</div>';
    });
  }

  function preprocessProofEnvironments() {
    var contentNode = document.querySelector('.page__content, .apple-article-body');
    if (!contentNode) return;
    
    var html = contentNode.innerHTML;
    
    // 匹配 $$\begin{proof}...\end{proof}$$ 或 \[\begin{proof}...\end{proof}\]
    var proofPattern = /(\$\$|\\\[)\s*\\begin\{proof\}([\s\S]*?)\\end\{proof\}\s*(\$\$|\\\])/g;
    
    html = html.replace(proofPattern, function(match, openDelim, content, closeDelim) {
      var id = 'proof-' + Math.random().toString(36).substr(2, 9);
      
      // 先在 proof 内容中处理 itemize 环境
      var processedContent = preprocessItemizeInContent(content.trim());
      
      var proofHtml = '<div class="proof-environment" id="' + id + '">' +
        '<div class="proof-title">Proof.</div>' +
        '<div class="proof-content">' + processedContent + '</div>' +
        '<div class="proof-qed">□</div>' +
        '</div>';
      
      return proofHtml;
    });
    
    contentNode.innerHTML = html;
  }

  function preprocessItemizeEnvironments() {
    var contentNode = document.querySelector('.page__content, .apple-article-body');
    if (!contentNode) return;
    
    var html = contentNode.innerHTML;
    
    // 处理独立的 itemize 环境（不在 proof 中的）
    var itemizePattern = /(\$\$|\\\[)\s*\\begin\{itemize\}([\s\S]*?)\\end\{itemize\}\s*(\$\$|\\\])/g;
    
    html = html.replace(itemizePattern, function(match, openDelim, content, closeDelim) {
      var id = 'itemize-' + Math.random().toString(36).substr(2, 9);
      
      // 分割 \item
      var items = content.split(/\\item/);
      var listItems = '';
      
      items.forEach(function(item) {
        item = item.trim();
        if (item) {
          listItems += '<li>' + item + '</li>';
        }
      });
      
      var itemizeHtml = '<div class="itemize-environment" id="' + id + '">' +
        '<ul>' + listItems + '</ul>' +
        '</div>';
      
      return itemizeHtml;
    });
    
    contentNode.innerHTML = html;
  }

  function fixInternalLinks() {
    // 处理 MathJax 生成的内部引用链接
    document.addEventListener('click', function(e) {
      var target = e.target;
      
      // 查找是否是链接或链接内的元素
      while (target && target.tagName !== 'A') {
        target = target.parentElement;
      }
      
      if (!target || target.tagName !== 'A') return;
      
      var href = target.getAttribute('href');
      
      // 检查是否是页面内锚点链接（以 # 开头）
      if (href && href.startsWith('#')) {
        e.preventDefault();
        
        var targetId = href.substring(1);
        var targetElement = document.getElementById(targetId);
        
        if (targetElement) {
          targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          
          // 更新 URL 但不刷新页面
          if (window.history && window.history.pushState) {
            window.history.pushState(null, '', href);
          }
        }
      }
    });
  }

  function applyAppleEquationNumbers() {
    var blocks = document.querySelectorAll('.apple-article-body mjx-container[display="true"]');
    var counter = 0;

    blocks.forEach(function (block) {
      var hasMathJaxTag = block.querySelector('mjx-tag') || block.querySelector('.mjx-tag');
      block.classList.add('apple-equation-block');

      if (hasMathJaxTag) {
        return;
      }

      counter += 1;
      var numberEl = block.querySelector('.apple-equation-number');
      if (!numberEl) {
        numberEl = document.createElement('span');
        numberEl.className = 'apple-equation-number';
        block.appendChild(numberEl);
      }
      numberEl.textContent = '(' + counter + ')';
    });
  }

  function normalizeCodeLanguageClasses() {
    var nodes = document.querySelectorAll('pre[class], code[class], div[class], figure[class]');
    var knownLanguages = ['latex', 'python'];

    nodes.forEach(function (node) {
      var classNames = Array.from(node.classList);
      classNames.forEach(function (className) {
        var lowerClass = className.toLowerCase();
        var languageMatch = className.match(/^language-(.+)$/i);

        if (languageMatch) {
          var normalizedLanguageClass = 'language-' + languageMatch[1].toLowerCase();
          if (normalizedLanguageClass !== className) {
            node.classList.remove(className);
          }
          if (!node.classList.contains(normalizedLanguageClass)) {
            node.classList.add(normalizedLanguageClass);
          }
          return;
        }
        if (knownLanguages.indexOf(lowerClass) !== -1) {
          if (lowerClass !== className) {
            node.classList.remove(className);
          }
          if (!node.classList.contains(lowerClass)) {
            node.classList.add(lowerClass);
          }
          if (!node.classList.contains('language-' + lowerClass)) {
            node.classList.add('language-' + lowerClass);
          }
        }
      });
    });
  }

  function pageHasMathContent() {
    var contentNode = document.querySelector('.page__content, .apple-article-body');
    if (!contentNode) {
      return false;
    }

    var rawText = contentNode.textContent || '';
    var hasDisplayOrLatexMarkers = /\$\$|\\\(|\\\)|\\\[|\\\]|\\begin\{|\\operatorname\{|\\boldsymbol\{|\\mathbb\{/.test(rawText);
    var hasInlineDollarMath = /(^|[^\\])\$[^$\n]+\$(?!\$)/.test(rawText);
    return hasDisplayOrLatexMarkers || hasInlineDollarMath;
  }

  function configureMathJax() {
    var commonTexPackages = [
      'ams',
      'newcommand',
      'configmacros',
      'textmacros',
      'mathtools',
      'physics',
      'cancel',
      'color',
      'braket',
      'html'
    ];

    var defaultMacros = {
      determinant: ['\\lvert #1 \\rvert', 1],
      item: '\\\\ \\text{• }'
    };
    var pageMacros = {{ page.mathjax_macros | jsonify }} || {};

    window.MathJax = {
      loader: {
        load: commonTexPackages.map(function (pkg) {
          return '[tex]/' + pkg;
        })
      },
      tex: {
        packages: {
          '[+]': commonTexPackages
        },
        inlineMath: [['$', '$'], ['\\(', '\\)']],
        displayMath: [['$$', '$$'], ['\\[', '\\]']],
        macros: Object.assign({}, defaultMacros, pageMacros),
        environments: {
          // proof 和 itemize 已通过 JavaScript 预处理，这里不再定义
        },
        processEscapes: true,
        processEnvironments: true,
        tags: 'all'
      },
      chtml: {
        linebreaks: {
          automatic: true,
          width: 'container'
        }
      },
      options: {
        skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      },
      startup: {
        pageReady: function () {
          return MathJax.startup.defaultPageReady().then(function () {
            applyAppleEquationNumbers();
          });
        }
      }
    };
  }

  function loadMathJaxIfNeeded() {
    var frontMatterEnabled = {{ page.mathjax | default: false | jsonify }};
    if (!frontMatterEnabled && !pageHasMathContent()) {
      return;
    }
    if (!window.MathJax) {
      configureMathJax();
    }

    if (!document.querySelector('link[data-mathjax-preconnect]')) {
      var preconnect = document.createElement('link');
      preconnect.rel = 'preconnect';
      preconnect.href = 'https://cdn.jsdelivr.net';
      preconnect.crossOrigin = 'anonymous';
      preconnect.setAttribute('data-mathjax-preconnect', 'true');
      document.head.appendChild(preconnect);
    }

    if (!document.querySelector('script[data-mathjax-script]')) {
      var script = document.createElement('script');
      script.defer = true;
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js';
      script.setAttribute('data-mathjax-script', 'true');
      document.head.appendChild(script);
      return;
    }

    if (window.MathJax && MathJax.typesetPromise) {
      MathJax.typesetPromise().then(function () {
        applyAppleEquationNumbers();
      });
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    preprocessProofEnvironments();      // 预处理 proof 环境（会同时处理内部的 itemize）
    preprocessItemizeEnvironments();    // 预处理独立的 itemize 环境
    normalizeCodeLanguageClasses();
    loadMathJaxIfNeeded();
    fixInternalLinks();                 // 修复内部链接跳转
  });
</script>

<!-- end custom head snippets -->