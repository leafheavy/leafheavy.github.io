---
title: "矩阵求导术"
date: 2024-02-16
permalink: /posts/2024/02/矩阵求导术/
tags:
  - 数学
category: tech
# 关键点: 开启 LaTeX 数学公式支持
mathjax: true
---

# Notation

| 定义                                                    | 含义        |
| ------------------------------------------------------- | ----------- |
| 小写字母 $ x $                                            | 标量 scalar |
| 粗体小写字母 $ \boldsymbol{x}\in \mathbb{R}^{n\times 1} $ | 向量 tensor |
| 大写字母 $X\in \mathbb{R}^{m\times n}$                  | 矩阵 matrix |

## 标量 $ f $ 对向量 $\boldsymbol{x}$ 的导数 (Eq. (1))

$$
df=\sum_{i=1}^{n} \frac{\partial f}{\partial x_i}dx_i = {\frac{\partial f}{\partial \boldsymbol{x}}}^{\top} d\boldsymbol{x}=<\nabla f, d\boldsymbol{x}>
$$

> 第一个等号是[全微分公式](https://zhida.zhihu.com/search?content_id=2070530&content_type=Article&match_order=1&q=全微分公式&zhida_source=entity)

$$
\begin{proof}
1. 全微分公式

\begin{align}
  \text{当 $z=f(x_1, x_2)$ 的时候, 有:}\\
  dz = \frac{\partial f}{\partial x_1}dx_1+\frac{\partial f}{\partial x_2}dx_2
\end{align}

当 z=f(x_1, x_2, ..., x_n) 的时候, 同样成立。
\end{proof}
$$

**核心思想**：全微分就是**所有自变量微小变化所引起函数值变化的线性叠加**。这里的"线性"很重要，它意味着我们忽略了高阶无穷小量（比如你走路时的拐弯效应），只考虑各个方向变化的直接相加。

> 第二个等号表达了梯度与微分的联系

\begin{proof}
  \begin{align}
    \label{def:relationship_between_gradient_and_differential}

    \frac{\partial f}{\partial \boldsymbol{x}}
    =
    \left[\begin{array}{c}
    \frac{\partial f}{\partial x_1}\\
    \frac{\partial f}{\partial x_2}\\
    ...\\
    \frac{\partial f}{\partial x_n}
    \end{array}\right], 

    d\boldsymbol{x}
    =
    \left[\begin{array}{c}
    dx_1\\
    dx_2\\
    ...\\
    dx_n
    \end{array}\right]

  \end{align}

  由 Eq.~\ref{def:relationship_between_gradient_and_differential} 的定义可得, 向量化表述吻合 $df$.

  \frac{\partial f}{\partial \boldsymbol{x}}^{\top} d\boldsymbol{x}= \frac{\partial f}{\partial x_1} dx_1 + \frac{\partial f}{\partial x_2} dx_2 + ... + \frac{\partial f}{\partial x_n} dx_n

\end{proof}

## 标量 $f$ 对矩阵 $X$ 的导数 (Eq. (7))

定义为: $f$ 对 $X$ 逐元素求导，之后排成与 $X\in \mathbb{R}^{m\times n}$ 尺寸相同的矩阵。
$$
\frac{\partial f}{\partial X}=[\frac{\partial f}{\partial X_{ij}}]
$$

> 用矩阵运算更整洁。所以在求导时不宜拆开矩阵，而是要找一个从整体出发的算法。

受 “标量 $f$ 对向量 $\boldsymbol{x}$ 的导数” 的启发，将矩阵导数与微分建立联系
$$
df=\sum_{i=1}^{m} \sum_{j=1}^{n} \frac{\partial f}{\partial X_{ij}}dX_{ij}=\operatorname{tr} \left( {\frac{\partial f}{\partial X_{ij}}}^{\top} dX\right)=<\nabla_X f, d\boldsymbol{x}>_{F}
$$

**几何本质没变**：$df$ 是**梯度矩阵**和**微分矩阵**的"内积"（仅多了个 $\operatorname{tr}$），衡量两者在"矩阵空间"中的"对齐程度"。


\begin{proof}
  我们有下述定义:

  \begin{align}

    \frac{\partial f}{\partial X}
    =
    \left[\begin{array}{ccc}
    \frac{\partial f}{\partial X_{11}}& \ldots& \frac{\partial f}{\partial X_{1n}}\\
    \vdots& \ddots& \vdots \\
    \frac{\partial f}{\partial X_{m1}}& \ldots& \frac{\partial f}{\partial X_{mn}}
    \end{array}\right], 

    dX
    =
    \left[\begin{array}{ccc}
    dX_{11}& \ldots& dX_{1n}\\
    \vdots& \ddots& \vdots \\
    dX_{m1}& \ldots& dX_{mn}
    \end{array}\right]

  \end{align}

  \begin{itemize}
    \item 矩阵的迹 $\operatorname{tr}(A)=\sum_k A_{kk}$ 是矩阵对角线元素之和
  \end{itemize}

  利用 Eq. (12) 有： 
  \begin{align}
    \operatorname{tr}\left(\left(\frac{\partial f}{\partial\boldsymbol{X}}\right)^\top d\boldsymbol{X}\right)=\sum_{i=1}^m\sum_{j=1}^n\left(\frac{\partial f}{\partial\boldsymbol{X}}\right)_{ij}\cdot(d\boldsymbol{X})_{ij}=\sum_{i=1}^m\sum_{j=1}^n\frac{\partial f}{\partial X_{ij}}dX_{ij}
  \end{align}
\end{proof}

**两个矩阵乘积的迹，等于它们所有对应位置的元素乘积的和 (弗罗贝尼乌斯内积)**

\begin{proof}

  \begin{align}
    \operatorname{tr}(\boldsymbol{A}^\top\boldsymbol{B})
    =&\sum_k(\boldsymbol{A}^\top\boldsymbol{B})_{kk}\\
    =&\sum_k\sum_j (A^{\top})_{kj}B_{jk}\\
    =&\sum_k\sum_j A_{jk}B_{jk}\\
    =&\sum_{i}\sum_{j} A_{ij}B_{ij}
  \end{align}

其中:
\begin{itemize}
  \item 第一个等号是矩阵的迹的定义；第二个等号是矩阵乘法运算的定义；
  \item 第三个等号是矩阵转置的定义；第四个等号是交换 Eq. (11) 的求和顺序之后重命名所得

\end{proof}

## 标量求导数

#### 方法论

首先求出微分 $df$；然后利用导数与微分的联系得到导数

- 若求导目标为**向量**，则对照 Eq. (1): $df = {\frac{\partial f}{\partial \boldsymbol{x}}}^{\top} d\boldsymbol{x}$.
- 若求导目标为**矩阵**，则对照 Eq. (7): $df = \operatorname{tr}\left( \frac{\partial f}{\partial X}^{T} \, dX \right)$.

> 举个例子：$f=\boldsymbol{a}\boldsymbol{x}$ 为标量函数；$\boldsymbol{a}, \boldsymbol{x}$ 均为列向量，求 $\frac{\partial f}{\partial \boldsymbol{x}}$.
>
> $f=\boldsymbol{a}^{\top}\boldsymbol{x}\Rightarrow df=d(\boldsymbol{a}^{\top}\boldsymbol{x}) \Rightarrow df=d\boldsymbol{a}^{\top}\cdot \boldsymbol{x}+\boldsymbol{a}^{\top}d\boldsymbol{x}\Rightarrow df=\boldsymbol{a}^{\top}d\boldsymbol{x}$.
>
> 对照 Eq. (1): $df = {\frac{\partial f}{\partial \boldsymbol{x}}}^{\top} d\boldsymbol{x}$ 不难得出: $\frac{\partial f}{\partial \boldsymbol{x}} = \boldsymbol{a}$.

所以**求导数**的难题变成了**求微分**。好在对于微分，我们有很多运算法则和性质可以利用：

#### 运算法则

- $d(X\pm Y)=dX \pm dY; d(XY)=(dX)Y+XdY \Rightarrow d(XYZ)=(dX)YZ+XdYZ+XYdZ$.

- $d(X^{\top})=(dX)^{\top}; dX^{-1}=-X^{-1}dXX^{-1}; d\operatorname{tr}(X)=\operatorname{tr}(dX)$

- $d\lvert X \rvert=\operatorname{tr}(\operatorname{adj}(X)\,dX)$。此处的 $\operatorname{adj}(X)$ 为 $X$ 的伴随矩阵；在 $X$ 可逆的时候，有 $d\lvert X \rvert=\lvert X \rvert\,\operatorname{tr}(X^{-1} dX)$（可由 Laplace 展开得到）。

- $d(X \odot Y) = dX \odot Y + X \odot dY$; 此处的 $\odot$ 算子表示尺寸相同的矩阵逐元素相乘

- $d\sigma(X)=\sigma'(X) \odot dX$; 此处的 $\sigma(X)=[\sigma(X_{ij})]$ 表示逐元素标量函数运算; $\sigma'(X)[\sigma'(X_{ij})]$ 表示逐元素求导数

#### 迹技巧 (trace trick)

- 标量套上迹: $a = \operatorname{tr}(a)$
- 转置: $\operatorname{tr}(A^{\top}) = \operatorname{tr}(A)$
- 线性: $\operatorname{tr}(A\pm B) = \operatorname{tr}(A) \pm \operatorname{tr}(B)$
- 矩阵乘法交换: $\operatorname{tr}(AB) = \operatorname{tr}(BA)$
- 矩阵乘法/逐元素乘法交换: $\operatorname{tr}(A^{\top}(B\odot C)) = \operatorname{tr}((A\odot B)^{\top}C)$ 两侧都等于 $\sum_{i.j} A_{ij}B_{ij}C_{ij}$

### 复合

![image-20251126210749454](/images/blogs/矩阵求导术/image-20251126210749454.png)

**Tips**

- $\log(\boldsymbol{u}/c)=\log(\boldsymbol{u})-\boldsymbol{1}\log(c)$
- $1^{\top}(\boldsymbol{u\odot \boldsymbol{v}})=\boldsymbol{u^{\top}\cdot \boldsymbol{v}}$

## 向量 $\boldsymbol{f}$ 对向量 $\boldsymbol{x}$ 的导数 (Eq. (15))

1. 定义向量 $\boldsymbol{f}\in \mathbb{R}^{p\times 1}$ 对向量 $\boldsymbol{x}\in \mathbb{R}^{m\times 1}$ 的导数 (此处采用的是分母布局)

   - $$
     \frac{\partial\boldsymbol{f}}{\partial \boldsymbol{x}} = 
     \begin{bmatrix}
     \frac{\partial f_1}{\partial x_1} & \frac{\partial f_2}{\partial x_1} & \cdots & \frac{\partial f_p}{\partial x_1} \\
     \frac{\partial f_1}{\partial x_2} & \frac{\partial f_2}{\partial x_2} & \cdots & \frac{\partial f_p}{\partial x_2} \\
     \vdots & \vdots & \ddots & \vdots \\
     \frac{\partial f_1}{\partial x_m} & \frac{\partial f_2}{\partial x_m} & \cdots & \frac{\partial f_p}{\partial x_m}
     \end{bmatrix}
     \in \mathbb{R}^{m\times p}
     $$

     有下式成立

   - $$
     d\boldsymbol{f} = \frac{\partial \boldsymbol{f}}{\partial \boldsymbol{x}}^{\top} d\boldsymbol{x}
     $$

## 矩阵 $F$ 对矩阵 $X$ 的导数 (Eq. (16))

### 定义

定义矩阵向量化算子 $\operatorname{vec}(X)=[X_{11},\dots,X_{m1},X_{12},\dots,X_{m2},\dots,X_{1n}\dots,X_{mn}]^{\top}\in \mathbb{R}^{mn\times 1}$

此处为 “按列优先”，即：列元素优先排

- <img src="/images/blogs/矩阵求导术/image-20251129171221796.png" alt="image-20251129171221796" style="width:50%;" />

定义矩阵 $F\in \mathbb{R}^{p\times q}$ 对矩阵 $X$ 的导数 $\frac{\partial F}{\partial X}=\frac{\partial \operatorname{vec}(F)}{\partial \operatorname{vec}(X)}\in \mathbb{R}^{mn\times pq}$

- 有下式成立

- $$
  \operatorname{vec}(dF) = \frac{\partial F}{\partial X}^{\top} \operatorname{vec}(dX)
  $$

### 向量化的运算法则

- **线性:** $\text{vec}(A + B) = \text{vec}(A) + \text{vec}(B)$

- **矩阵乘法:** $\text{vec}(AXB) = (B^T \otimes A) \text{vec}(X)$

  - $\otimes$ 表示 Kronecker 积

    - 设 $A = \begin{bmatrix}
      a_{11} & a_{12} \\
      a_{21} & a_{22}
      \end{bmatrix}, \quad
      B = \begin{bmatrix}
      b_{11} & b_{12} \\
      b_{21} & b_{22}
      \end{bmatrix}$，则有：

    - $$
      A \otimes B = \begin{bmatrix}
      a_{11}B & a_{12}B \\
      a_{21}B & a_{22}B
      \end{bmatrix} = \begin{bmatrix}
      a_{11}b_{11} & a_{11}b_{12} & a_{12}b_{11} & a_{12}b_{12} \\
      a_{11}b_{21} & a_{11}b_{22} & a_{12}b_{21} & a_{12}b_{22} \\
      a_{21}b_{11} & a_{21}b_{12} & a_{22}b_{11} & a_{22}b_{12} \\
      a_{21}b_{21} & a_{21}b_{22} & a_{22}b_{21} & a_{22}b_{22}
      \end{bmatrix}
      $$

- **转置:** $\text{vec}(A^T) = K_{mn} \text{vec}(A)$

  - $K_{mn}$ 表示交换矩阵 (commutation matrix)，将**按列优先**的向量化**变为按行优先**的向量化。

  - $$
    K_{22} = \begin{bmatrix}
    1 & 0 & 0 & 0 \\
    0 & 0 & 1 & 0 \\
    0 & 1 & 0 & 0 \\
    0 & 0 & 0 & 1
    \end{bmatrix}, \quad
    \text{vec}(A^T) = \begin{bmatrix}
    A_{11} \\
    A_{12} \\
    A_{21} \\
    A_{22}
    \end{bmatrix}, \quad
    \text{vec}(A) = \begin{bmatrix}
    A_{11} \\
    A_{21} \\
    A_{12} \\
    A_{22}
    \end{bmatrix}.
    $$
  
- **逐元素乘法:** $\text{vec}(A \odot X) = \text{diag}(A) \text{vec}(X)$

  - $\operatorname{diag}(A)$ 表示用 A 的所有元素（按列优先）排成的对角阵
  - $\operatorname{diag}(A)^{\top} = \operatorname{diag}(A)$
  - **Tips: 对于任意向量有：** $\boldsymbol{a} \odot \boldsymbol{b} = \operatorname{diag}(\boldsymbol{a})\boldsymbol{b}$
  - 设   $\mathbf a = \begin{bmatrix} a_1 \\ a_2 \\ a_3 \end{bmatrix}, \quad \mathbf b = \begin{bmatrix} b_1 \\ b_2 \\ b_3 \end{bmatrix} 那么   $$\mathbf a \odot \mathbf b = \begin{bmatrix} a_1 b_1 \\ a_2 b_2 \\ a_3 b_3 \end{bmatrix}$
    把 $\mathbf a$ 放到对角线上，得到 $\mathrm{diag}(\mathbf a) =  \begin{bmatrix} a_1 & 0   & 0   \\ 0   & a_2 & 0   \\ 0   & 0   & a_3 \end{bmatrix} $ 用它去乘 $\mathbf b$： $\mathrm{diag}(\mathbf a)\,\mathbf b = \begin{bmatrix} a_1 & 0   & 0   \\ 0   & a_2 & 0   \\ 0   & 0   & a_3 \end{bmatrix} \begin{bmatrix} b_1 \\ b_2 \\ b_3 \end{bmatrix} = \begin{bmatrix} a_1 b_1 \\ a_2 b_2 \\ a_3 b_3 \end{bmatrix} $

### Kronecker积和交换矩阵相关的恒等式

- **:** $(A \otimes B)^T = A^T \otimes B^T$
- **:** $\text{vec}(ab^T) = b \otimes a$
- **:** $(A \otimes B)(C \otimes D) = (AC) \otimes (BD)$
- **:** $K_{mn} = K_{nm}^T, \quad K_{mn} K_{nm} = I$
- **:** $K_{pm} (A \otimes B) K_{nq} = B \otimes A$

---
> # Reference
> [1] [(72 封私信 / 83 条消息) 矩阵求导术（上） - 知乎](https://zhuanlan.zhihu.com/p/24709748)
>
> [2] [(72 封私信 / 83 条消息) 矩阵求导术（下） - 知乎](https://zhuanlan.zhihu.com/p/24863977)